<script>
  // ==== PANTALLA DE CARGA CORREGIDA ====
  function initGame() {
    // Pedir nombre si no lo tiene
    let playerName = localStorage.getItem('playerName');
    if (!playerName) {
      playerName = prompt("¬øC√≥mo te llamas, jugador/a?") || "Jugador";
      localStorage.setItem('playerName', playerName);
    }
    document.getElementById('playerName').innerText = playerName;

    // Cerrar pantalla de carga
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
    
    // Iniciar todo lo dem√°s
    createParticles();
    updateUI();
    renderCollection();
    updateRanking();
    startUpdateCountdown();
    startLegendaryCountdown();
    
    // Reproducir m√∫sica
    const music = document.getElementById('gameMusic');
    music.volume = 0.3;
    music.play().catch(() => {
      console.warn("Autoplay fall√≥. M√∫sica en pausa.");
    });
  }

  // Iniciar el juego cuando la p√°gina est√© lista
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGame);
  } else {
    initGame();
  }

  // ==== RESTO DEL C√ìDIGO IGUAL (sin cambios) ====
  const CARDS = [
    { id:0, name:"Ram√≠rez", img:"https://s93.erome.com/5472/K3IRZbxx/Y8DPmT76.jpeg?v=1764825894", rarity:"common", atk:60, def:50, power:"Paso Firme", attackType:"wind", unlocked: true },
    { id:1, name:"Azulita", img:"https://s93.erome.com/5472/K3IRZbxx/0B8OzReu.jpeg?v=1764815871", rarity:"rare", atk:70, def:55, power:"Confeti √Åcido", attackType:"fire", unlocked: true },
    { id:2, name:"Tormenta", img:"https://s93.erome.com/5472/K3IRZbxx/7GmdJa3U.jpeg?v=1764802552", rarity:"epic", atk:80, def:45, power:"Torbellino", attackType:"wind", unlocked: false },
    { id:3, name:"Fortaleza", img:"https://s93.erome.com/5472/K3IRZbxx/1FvcJ5u7.png?v=1764809177", rarity:"rare", atk:60, def:70, power:"Muralla", attackType:"ice", unlocked: true },
    { id:4, name:"Danza", img:"https://s93.erome.com/5472/K3IRZbxx/0VxSvgAl.jpeg?v=1764818017", rarity:"epic", atk:75, def:50, power:"Baile √âpico", attackType:"wind", unlocked: false },
    { id:5, name:"Furia", img:"https://s93.erome.com/5472/K3IRZbxx/LsMURibY.jpeg?v=1764812622", rarity:"legendary", atk:90, def:40, power:"Ira Incontenible", attackType:"fire", unlocked: false },
    { id:6, name:"Escudera", img:"https://s93.erome.com/5472/K3IRZbxx/9RweIpam.jpeg?v=1764813677", rarity:"common", atk:55, def:65, power:"Protecci√≥n", attackType:"ice", unlocked: true },
    { id:7, name:"Asesina", img:"https://s206.erome.com/4699/lpRzYjBO/Z5Tc5k2v.jpeg?v=1745795818", rarity:"legendary", atk:95, def:30, power:"Golpe Letal", attackType:"fire", unlocked: false },
    { id:8, name:"Guardiana", img:"https://s206.erome.com/4699/lpRzYjBO/P9p2wv5y.jpeg?v=1745795818", rarity:"epic", atk:50, def:80, power:"Escudo Energ√©tico", attackType:"ice", unlocked: false },
    { id:9, name:"IA √âLITE", img:"https://s206.erome.com/4699/lpRzYjBO/gU2HfmRY.jpeg?v=1745795818", rarity:"legendary", atk:100, def:35, power:"Tirano", attackType:"arcane", unlocked: true },
    { id:10, name:"Sellamara Gemelas", img:"https://rule34.xxx/samples/457/sample_f9bc1e16c821e5923b37a699ea624f9c.jpg?15733609", rarity:"legendary", atk:120, def:60, power:"Desaf√≠o Final", attackType:"arcane", unlocked: false }
  ];

  const LEAGUES = [
    { name: "Bronce", min: 0, max: 199, badgeClass: "league-bronze", iaMod: -20 },
    { name: "Plata", min: 200, max: 399, badgeClass: "league-silver", iaMod: 0 },
    { name: "Oro", min: 400, max: 599, badgeClass: "league-gold", iaMod: 20 },
    { name: "√âlite", min: 600, max: 799, badgeClass: "league-elite", iaMod: 40 },
    { name: "Leyenda", min: 800, max: Infinity, badgeClass: "league-legend", iaMod: 60 }
  ];

  let currentDeck = JSON.parse(localStorage.getItem('currentDeck')) || [0, 3, 6];
  let playerCards = [];
  let enemyCard = null;
  let gameActive = true;
  let playerTurn = true;
  let selectedPlayerCard = null;
  let trophies = parseInt(localStorage.getItem('trophies')) || 0;
  let diamonds = 100;
  let currentLeague = LEAGUES[0];

  const today = new Date().toDateString();
  const lastDiamondClaim = localStorage.getItem('lastDiamondClaim');
  if (lastDiamondClaim !== today) {
    localStorage.setItem('diamonds', 100);
    localStorage.setItem('lastDiamondClaim', today);
  }
  diamonds = parseInt(localStorage.getItem('diamonds')) || 100;

  const savedCards = JSON.parse(localStorage.getItem('cards')) || {};
  CARDS.forEach(card => {
    if (savedCards[card.id] !== undefined) {
      card.unlocked = savedCards[card.id];
    }
    if (card.id === 10) card.unlocked = false;
  });

  function saveCollection() {
    const state = {};
    CARDS.forEach(card => state[card.id] = card.unlocked);
    state[10] = false;
    localStorage.setItem('cards', JSON.stringify(state));
  }

  function updateUI() {
    document.getElementById('trophyCount').innerText = trophies;
    
    const newLeague = LEAGUES.find(l => trophies >= l.min && trophies <= l.max) || LEAGUES[0];
    if (newLeague.name !== currentLeague.name) {
      currentLeague = newLeague;
      showNotification(`¬°Ascendiste a ${newLeague.name}! üéâ`);
    }
    document.getElementById('leagueBadge').className = `league-badge ${newLeague.badgeClass}`;
    document.getElementById('leagueBadge').innerText = newLeague.name;
    document.getElementById('arenaName').innerText = newLeague.name;

    localStorage.setItem('diamonds', diamonds);
    document.getElementById('diamondCount').innerText = diamonds;
  }

  function updateRanking() {
    const playerName = localStorage.getItem('playerName') || "Jugador";
    let rankings = JSON.parse(localStorage.getItem('rankings')) || [];
    
    const existingIndex = rankings.findIndex(r => r.name === playerName);
    if (existingIndex >= 0) {
      rankings[existingIndex].trophies = trophies;
    } else {
      rankings.push({ name: playerName, trophies });
    }
    
    rankings.sort((a, b) => b.trophies - a.trophies);
    rankings = rankings.slice(0, 10);
    localStorage.setItem('rankings', JSON.stringify(rankings));
    
    const listEl = document.getElementById('rankingList');
    listEl.innerHTML = '';
    rankings.forEach((r, i) => {
      const item = document.createElement('div');
      item.className = 'ranking-item';
      item.innerHTML = `<span>${i+1}. ${r.name}</span><span>${r.trophies} üèÜ</span>`;
      listEl.appendChild(item);
    });
  }

  function showNotification(msg) {
    const notif = document.createElement('div');
    notif.innerText = msg;
    notif.style.position = 'fixed';
    notif.style.top = '20%';
    notif.style.left = '50%';
    notif.style.transform = 'translateX(-50%)';
    notif.style.background = 'gold';
    notif.style.color = '#0a0a1a';
    notif.style.padding = '10px 20px';
    notif.style.borderRadius = '10px';
    notif.style.fontWeight = 'bold';
    notif.style.zIndex = '1000';
    notif.style.fontSize = '1.2em';
    document.body.appendChild(notif);
    setTimeout(() => document.body.removeChild(notif), 3000);
  }

  let credits = 100;
  function buyItem(id, cost) {
    if (credits >= cost) {
      credits -= cost;
      localStorage.setItem(`owned_${id}`, 'true');
      document.getElementById('storeMessage').innerText = '¬°Compra exitosa! üéâ';
      setTimeout(() => document.getElementById('storeMessage').innerText = '', 3000);
    } else {
      document.getElementById('storeMessage').innerText = '‚ùå Cr√©ditos insuficientes.';
      setTimeout(() => document.getElementById('storeMessage').innerText = '', 3000);
    }
  }

  function showView(view) {
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    document.getElementById('battleView').style.display = view === 'battle' ? 'block' : 'none';
    document.getElementById('collectionView').style.display = view === 'collection' ? 'block' : 'none';
    document.getElementById('storeView').style.display = view === 'store' ? 'block' : 'none';
    document.getElementById('rankingView').style.display = view === 'ranking' ? 'block' : 'none';
    document.getElementById('battleTable').style.display = 'none';
  }

  function showCardPreview(card) {
    document.getElementById('previewImg').src = card.img;
    document.getElementById('previewName').innerText = card.name;
    
    const rarityColors = {
      common: "rarity-common-tag",
      rare: "rarity-rare-tag",
      epic: "rarity-epic-tag",
      legendary: "rarity-legendary-tag"
    };
    const rarityNames = {
      common: "Com√∫n",
      rare: "Rara",
      epic: "√âpica",
      legendary: "Legendaria"
    };
    
    const rarityEl = document.getElementById('previewRarity');
    rarityEl.className = `rarity-tag ${rarityColors[card.rarity]}`;
    rarityEl.innerText = rarityNames[card.rarity];
    
    document.getElementById('previewStats').innerText = `ATK: ${card.atk} | DEF: ${card.def}`;
    document.getElementById('previewPower').innerText = card.power;
    
    const timerEl = document.getElementById('legendaryTimer');
    if (card.id === 10) {
      timerEl.style.display = 'block';
      timerEl.innerText = 'Se desbloquear√° ma√±ana a las 15:00';
    } else {
      timerEl.style.display = 'none';
    }
    
    document.getElementById('cardPreview').classList.add('show');
  }

  document.getElementById('cardPreview').onclick = () => {
    document.getElementById('cardPreview').classList.remove('show');
  };

  function renderCollection() {
    const grid = document.getElementById('collectionGrid');
    grid.innerHTML = '';
    CARDS.slice(0, -1).forEach(card => {
      const isLocked = (card.id === 10) ? true : !card.unlocked;
      const div = document.createElement('div');
      div.className = `collection-card ${isLocked ? 'locked' : 'unlocked'}`;
      if (!isLocked) {
        const img = document.createElement('img');
        img.src = card.img;
        img.alt = card.name;
        img.style.cursor = 'pointer';
        img.onclick = () => showCardPreview(card);
        div.appendChild(img);
      } else if (card.id === 10) {
        const img = document.createElement('img');
        img.src = card.img;
        img.alt = card.name;
        img.style.filter = 'grayscale(100%)';
        img.style.cursor = 'not-allowed';
        div.appendChild(img);
        div.onclick = () => showCardPreview(card);
      }
      grid.appendChild(div);
    });

    const deckEl = document.getElementById('currentDeck');
    deckEl.innerHTML = '';
    currentDeck.forEach(id => {
      if (id === 10) return;
      const card = CARDS.find(c => c.id === id && c.unlocked);
      if (card) {
        const cardEl = document.createElement('div');
        cardEl.style.width = '100px';
        cardEl.style.margin = '5px';
        cardEl.innerHTML = `<img src="${card.img}" style="width:100%; border-radius:8px;" onclick="showCardPreview(${JSON.stringify(card).replace(/"/g, '&quot;')})">`;
        deckEl.appendChild(cardEl);
      }
    });
  }

  function addToDeck(cardId) {
    if (cardId === 10) {
      alert('¬°Sellamara Gemelas se desbloquear√° ma√±ana a las 15:00!');
      return;
    }
    if (currentDeck.length >= 3) {
      alert('Tu mazo solo puede tener 3 cartas.');
      return;
    }
    if (!currentDeck.includes(cardId)) {
      currentDeck.push(cardId);
      renderCollection();
    }
  }

  function saveDeck() {
    currentDeck = currentDeck.filter(id => id !== 10);
    if (currentDeck.length !== 3) {
      alert('¬°Tu mazo debe tener exactamente 3 cartas!');
      return;
    }
    localStorage.setItem('currentDeck', JSON.stringify(currentDeck));
    showNotification('¬°Mazo guardado!');
  }

  function playAttackEffect(type) {
    const overlay = document.getElementById('attackOverlay');
    overlay.className = 'attack-overlay';
    overlay.classList.add(`${type}-effect`);
    overlay.style.opacity = '1';
    
    const soundMap = {
      fire: 'fireSound',
      ice: 'iceSound',
      wind: 'windSound',
      arcane: 'arcaneSound'
    };
    const sound = document.getElementById(soundMap[type]);
    if (sound) sound.play().catch(()=>{});
    
    setTimeout(() => {
      overlay.style.opacity = '0';
    }, 1000);
  }

  function startBattle() {
    const savedDeck = JSON.parse(localStorage.getItem('currentDeck')) || [0, 3, 6];
    currentDeck = savedDeck.filter(id => id !== 10);

    playerCards = [];
    currentDeck.forEach(id => {
      const card = CARDS.find(c => c.id === id && c.unlocked);
      if (card) {
        playerCards.push({...card, currentHp: card.def, alive: true});
      }
    });

    if (playerCards.length === 0) {
      alert('¬°Tu mazo est√° vac√≠o! Ve a "Mazo" y arma tu mazo.');
      return;
    }

    const iaCard = {...CARDS[9], currentHp: CARDS[9].def, alive: true};
    enemyCard = iaCard;

    gameActive = true;
    playerTurn = true;
    selectedPlayerCard = null;

    document.getElementById('battleView').style.display = 'none';
    document.getElementById('battleTable').style.display = 'block';
    
    updateBattleUI();
  }

  function updateBattleUI() {
    document.getElementById('enemyCardImg').src = enemyCard.img;
    document.getElementById('enemyRarity').innerText = enemyCard.rarity;
    document.getElementById('enemyRarity').className = `card-rarity ${enemyCard.rarity}`;
    document.getElementById('enemyHp').innerText = enemyCard.currentHp;
    document.getElementById('enemyHpBar').style.width = `${(enemyCard.currentHp / enemyCard.def) * 100}%`;
    
    if (selectedPlayerCard) {
      document.getElementById('playerCardImg').src = selectedPlayerCard.img;
      document.getElementById('playerRarity').innerText = selectedPlayerCard.rarity;
      document.getElementById('playerRarity').className = `card-rarity ${selectedPlayerCard.rarity}`;
      document.getElementById('playerHp').innerText = selectedPlayerCard.currentHp;
      document.getElementById('playerHpBar').style.width = `${(selectedPlayerCard.currentHp / selectedPlayerCard.def) * 100}%`;
    }

    const handEl = document.getElementById('playerHand');
    handEl.innerHTML = '';
    playerCards.forEach(card => {
      if (card.alive) {
        const cardEl = document.createElement('div');
        cardEl.className = 'hand-card';
        cardEl.innerHTML = `
          <img src="${card.img}" alt="${card.name}">
          <div style="font-size:0.9em; margin-top:5px;">${card.name}</div>
        `;
        cardEl.onclick = () => {
          selectedPlayerCard = card;
          attackWithSelected();
        };
        handEl.appendChild(cardEl);
      }
    });
  }

  function attackWithSelected() {
    if (!gameActive || !playerTurn || !selectedPlayerCard) return;
    
    const log = document.getElementById('battleLog');
    log.innerHTML = `¬°${selectedPlayerCard.name} usa <strong>${selectedPlayerCard.power}</strong>!`;

    playAttackEffect(selectedPlayerCard.attackType);

    const damage = Math.max(5, selectedPlayerCard.atk - Math.floor(enemyCard.def * 0.3));
    setTimeout(() => {
      enemyCard.currentHp = Math.max(0, enemyCard.currentHp - damage);
      updateBattleUI();

      if (enemyCard.currentHp <= 0) {
        log.innerHTML = `¬°${selectedPlayerCard.name} derrot√≥ a la IA!`;
        setTimeout(() => {
          trophies += 30;
          localStorage.setItem('trophies', trophies);
          updateUI();
          updateRanking();
          const msg = `¬°Ganaste 30 trofeos!<br>Total: ${trophies} trofeos.`;
          showEndScreen(true, msg);
        }, 1500);
      } else {
        log.innerHTML += `<br>¬°Turno de la IA!`;
        setTimeout(() => iaAttack(), 1500);
      }
      playerTurn = false;
    }, 1000);
  }

  function iaAttack() {
    if (!gameActive || !selectedPlayerCard) return;
    
    const log = document.getElementById('battleLog');
    log.innerHTML = `¬°La IA ataca a ${selectedPlayerCard.name}!`;

    playAttackEffect(enemyCard.attackType);

    const baseDamage = Math.max(5, enemyCard.atk - Math.floor(selectedPlayerCard.def * 0.3));
    const modifier = currentLeague.iaMod / 100;
    const damage = Math.round(baseDamage * (1 + modifier));

    setTimeout(() => {
      selectedPlayerCard.currentHp = Math.max(0, selectedPlayerCard.currentHp - damage);
      updateBattleUI();

      if (selectedPlayerCard.currentHp <= 0) {
        selectedPlayerCard.alive = false;
        log.innerHTML = `¬°${selectedPlayerCard.name} fue eliminada!`;
        
        const aliveCards = playerCards.filter(c => c.alive);
        if (aliveCards.length === 0) {
          trophies = Math.max(0, trophies - 15);
          localStorage.setItem('trophies', trophies);
          updateUI();
          updateRanking();
          const msg = `Perdiste 15 trofeos.<br>Total: ${trophies} trofeos.`;
          showEndScreen(false, msg);
          return;
        }
        selectedPlayerCard = aliveCards[0];
      }

      playerTurn = true;
      log.innerHTML = `¬°Tu turno! Elige una carta para atacar:`;
    }, 1000);
  }

  function showEndScreen(isWin, message) {
    gameActive = false;
    const log = document.getElementById('battleLog');
    log.innerHTML = `
      <h3 style="color:${isWin ? 'gold' : '#ff6b6b'};">
        ${isWin ? 'üéâ ¬°VICTORIA!' : 'üíÄ DERROTA'}
      </h3>
      <p style="margin:15px 0;">${message}</p>
      <button class="action-btn" onclick="startBattle()" style="margin-top:15px;">üîÑ Otra Partida</button>
    `;
    document.getElementById(isWin ? 'winSound' : 'loseSound').play();
  }

  function exitBattle() {
    document.getElementById('battleTable').style.display = 'none';
    document.getElementById('battleView').style.display = 'block';
    showNotification(`Trofeos: ${trophies} | Diamantes: ${diamonds}`);
  }

  function createParticles() {
    const c = document.getElementById('particles');
    const n = 15;
    for (let i = 0; i < n; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      const s = Math.random() * 4 + 1;
      p.style.width = p.style.height = `${s}px`;
      p.style.left = `${Math.random() * 100}%`;
      p.style.top = `${Math.random() * 100}%`;
      const cols = ['rgba(255,107,107,0.7)','rgba(78,205,196,0.7)','rgba(254,202,87,0.7)'];
      p.style.background = cols[Math.floor(Math.random() * cols.length)];
      p.style.setProperty('--tx', `${(Math.random()-0.5)*200}px`);
      p.style.setProperty('--ty', `${(Math.random()-0.5)*200}px`);
      p.style.animationDuration = `${15 + Math.random() * 20}s`;
      c.appendChild(p);
    }
  }

  function startUpdateCountdown() {
    function updateTimer() {
      const now = new Date();
      const target = new Date(now);
      target.setHours(15, 0, 0, 0);
      if (now >= target) {
        target.setDate(target.getDate() + 1);
      }
      const diff = target - now;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);
      
      if (diff <= 0) {
        document.getElementById('updateTimer').innerText = '¬°La actualizaci√≥n ya est√° disponible! üéÅ';
      } else {
        document.getElementById('updateTimer').innerText = 
          `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      }
    }
    updateTimer();
    setInterval(updateTimer, 1000);
  }

  function startLegendaryCountdown() {
    // Similar, pero para la carta legendaria (ma√±ana a las 15:00)
    // Se muestra en la vista detallada
  }
</script>
