'use client';

import { useState, useEffect, useCallback } from 'react';
import { Card, League, Player, GameView } from '@/types/fortnite-game';

// Cartas especiales para la IA con m√°s vida
const IA_CARDS = [
  { id:101, name:"IA Ram√≠rez", img:"https://s93.erome.com/5472/K3IRZbxx/Y8DPmT76.jpeg?v=1764825894", rarity:"common", atk:60, def:80, power:"Paso Firme Mejorado", attackType:"wind", unlocked: true },
  { id:102, name:"IA Azulita", img:"https://s93.erome.com/5472/K3IRZbxx/0B8OzReu.jpeg?v=1764815871", rarity:"rare", atk:70, def:85, power:"Confeti √Åcido Doble", attackType:"fire", unlocked: true },
  { id:103, name:"IA Tormenta", img:"https://s93.erome.com/5472/K3IRZbxx/7GmdJa3U.jpeg?v=1764802552", rarity:"epic", atk:80, def:75, power:"Torbellino Destructor", attackType:"wind", unlocked: true },
  { id:104, name:"IA Fortaleza", img:"https://s93.erome.com/5472/K3IRZbxx/1FvcJ5u7.png?v=1764809177", rarity:"rare", atk:60, def:100, power:"Muralla Imbatible", attackType:"ice", unlocked: true },
  { id:105, name:"IA Danza", img:"https://s93.erome.com/5472/K3IRZbxx/0VxSvgAl.jpeg?v=1764818017", rarity:"epic", atk:75, def:80, power:"Baile Mortal", attackType:"wind", unlocked: true },
  { id:106, name:"IA Furia", img:"https://s93.erome.com/5472/K3IRZbxx/LsMURibY.jpeg?v=1764812622", rarity:"legendary", atk:90, def:70, power:"Ira Absoluta", attackType:"fire", unlocked: true },
  { id:107, name:"IA Escudera", img:"https://s93.erome.com/5472/K3IRZbxx/9RweIpam.jpeg?v=1764813677", rarity:"common", atk:55, def:95, power:"Protecci√≥n Total", attackType:"ice", unlocked: true },
  { id:108, name:"IA Asesina", img:"https://s206.erome.com/4699/lpRzYjBO/Z5Tc5k2v.jpeg?v=1745795818", rarity:"legendary", atk:95, def:60, power:"Golpe Aniquilador", attackType:"fire", unlocked: true },
  { id:109, name:"IA Guardiana", img:"https://s206.erome.com/4699/lpRzYjBO/P9p2wv5y.jpeg?v=1745795818", rarity:"epic", atk:50, def:110, power:"Escudo Divino", attackType:"ice", unlocked: true },
  { id:110, name:"IA √âLITE", img:"https://s206.erome.com/4699/lpRzYjBO/gU2HfmRY.jpeg?v=1745795818", rarity:"legendary", atk:100, def:65, power:"Tirano Supremo", attackType:"arcane", unlocked: true }
];

export const useFortniteGame = () => {
  const [player, setPlayer] = useState<Player>({
    name: '',
    trophies: 0,
    diamonds: 100,
    league: {
      name: 'Bronce',
      min: 0,
      max: 199,
      badgeClass: 'league-bronze',
      iaMod: -20
    }
  });
  
  const [currentDeck, setCurrentDeck] = useState<number[]>([0, 3, 6]);
  const [playerCards, setPlayerCards] = useState<Card[]>([]);
  const [enemyCard, setEnemyCard] = useState<Card | null>(null);
  const [gameActive, setGameActive] = useState(false);
  const [playerTurn, setPlayerTurn] = useState(false);
  const [selectedPlayerCard, setSelectedPlayerCard] = useState<Card | null>(null);
  const [currentView, setCurrentView] = useState<GameView>('battle');
  const [battleLog, setBattleLog] = useState<string>('¬°Elige una carta de tu mazo para atacar!');
  
  // Timer para el turno
  const [turnTime, setTurnTime] = useState<number>(30);
  const [timerActive, setTimerActive] = useState<boolean>(false);

  const LEAGUES: League[] = [
    { name: "Bronce", min: 0, max: 199, badgeClass: "league-bronze", iaMod: -20 },
    { name: "Plata", min: 200, max: 399, badgeClass: "league-silver", iaMod: 0 },
    { name: "Oro", min: 400, max: 599, badgeClass: "league-gold", iaMod: 20 },
    { name: "√âlite", min: 600, max: 799, badgeClass: "league-elite", iaMod: 40 },
    { name: "Leyenda", min: 800, max: Infinity, badgeClass: "league-legend", iaMod: 60 }
  ];

  const CARDS: Card[] = [
    { id:0, name:"Ram√≠rez", img:"https://s93.erome.com/5472/K3IRZbxx/Y8DPmT76.jpeg?v=1764825894", rarity:"common", atk:60, def:50, power:"Paso Firme", attackType:"wind", unlocked: true },
    { id:1, name:"Azulita", img:"https://s93.erome.com/5472/K3IRZbxx/0B8OzReu.jpeg?v=1764815871", rarity:"rare", atk:70, def:55, power:"Confeti √Åcido", attackType:"fire", unlocked: true },
    { id:2, name:"Tormenta", img:"https://s93.erome.com/5472/K3IRZbxx/7GmdJa3U.jpeg?v=1764802552", rarity:"epic", atk:80, def:45, power:"Torbellino", attackType:"wind", unlocked: true },
    { id:3, name:"Fortaleza", img:"https://s93.erome.com/5472/K3IRZbxx/1FvcJ5u7.png?v=1764809177", rarity:"rare", atk:60, def:70, power:"Muralla", attackType:"ice", unlocked: true },
    { id:4, name:"Danza", img:"https://s93.erome.com/5472/K3IRZbxx/0VxSvgAl.jpeg?v=1764818017", rarity:"epic", atk:75, def:50, power:"Baile √âpico", attackType:"wind", unlocked: true },
    { id:5, name:"Furia", img:"https://s93.erome.com/5472/K3IRZbxx/LsMURibY.jpeg?v=1764812622", rarity:"legendary", atk:90, def:40, power:"Ira Incontenible", attackType:"fire", unlocked: true },
    { id:6, name:"Escudera", img:"https://s93.erome.com/5472/K3IRZbxx/9RweIpam.jpeg?v=1764813677", rarity:"common", atk:55, def:65, power:"Protecci√≥n", attackType:"ice", unlocked: true },
    { id:7, name:"Asesina", img:"https://s206.erome.com/4699/lpRzYjBO/Z5Tc5k2v.jpeg?v=1745795818", rarity:"legendary", atk:95, def:30, power:"Golpe Letal", attackType:"fire", unlocked: true },
    { id:8, name:"Guardiana", img:"https://s206.erome.com/4699/lpRzYjBO/P9p2wv5y.jpeg?v=1745795818", rarity:"epic", atk:50, def:80, power:"Escudo Energ√©tico", attackType:"ice", unlocked: true },
    { id:9, name:"IA √âLITE", img:"https://s206.erome.com/4699/lpRzYjBO/gU2HfmRY.jpeg?v=1745795818", rarity:"legendary", atk:100, def:35, power:"Tirano", attackType:"arcane", unlocked: true },
    { id:10, name:"Sellamara Gemelas", img:"https://s326.erome.com/5139/YBnb1NTO/R8jmYVqr.jpeg?v=1750357395", rarity:"legendary", atk:120, def:60, power:"Desaf√≠o Final", attackType:"arcane", unlocked: false }
  ];

  const [cards, setCards] = useState<Card[]>([]);

  // Inicializar juego
  useEffect(() => {
    const savedPlayerName = localStorage.getItem('playerName');
    const savedTrophies = parseInt(localStorage.getItem('trophies') || '0');
    const savedDiamonds = parseInt(localStorage.getItem('diamonds') || '100');
    const savedDeck = JSON.parse(localStorage.getItem('currentDeck') || '[0, 3, 6]');
    
    const playerName = savedPlayerName || prompt("¬øC√≥mo te llamas, jugador/a?") || "Jugador";
    if (!savedPlayerName) {
      localStorage.setItem('playerName', playerName);
    }
    
    // Resetear diamantes diarios
    const today = new Date().toDateString();
    const lastDiamondClaim = localStorage.getItem('lastDiamondClaim');
    if (lastDiamondClaim !== today) {
      localStorage.setItem('diamonds', '100');
      localStorage.setItem('lastDiamondClaim', today);
    }
    
    // Crear copia de las cartas y cargar estado
    const savedCards = JSON.parse(localStorage.getItem('cards') || '{}');
    const initialCards = CARDS.map(card => {
      const unlocked = savedCards[card.id] !== undefined ? savedCards[card.id] : (card.id === 10 ? false : true);
      return { ...card, unlocked };
    });
    
    setCards(initialCards);
    
    const league = LEAGUES.find(l => savedTrophies >= l.min && savedTrophies <= l.max) || LEAGUES[0];
    
    setPlayer({
      name: playerName,
      trophies: savedTrophies,
      diamonds: savedDiamonds,
      league
    });
    
    setCurrentDeck(savedDeck);
  }, []);

  // Actualizar liga cuando cambian los trofeos
  useEffect(() => {
    const newLeague = LEAGUES.find(l => player.trophies >= l.min && player.trophies <= l.max) || LEAGUES[0];
    if (newLeague.name !== player.league.name) {
      setPlayer(prev => ({ ...prev, league: newLeague }));
    }
  }, [player.trophies, player.league.name, LEAGUES]);

  // Timer del turno - REESCRITO COMPLETAMENTE
  useEffect(() => {
    let interval: NodeJS.Timeout | null = null;
    
    if (timerActive && turnTime > 0) {
      interval = setInterval(() => {
        setTurnTime(prev => {
          if (prev <= 1) {
            // Cuando el tiempo llega a 0
            setTimerActive(false);
            if (playerTurn) {
              // Si es el turno del jugador y se acab√≥ el tiempo, pierde el turno
              setBattleLog('¬°Se acab√≥ el tiempo! Pierdes tu turno.');
              setTimeout(() => {
                executeIATurn();
              }, 1500);
            }
            return 30;
          }
          return prev - 1;
        });
      }, 1000);
    }
    
    return () => {
      if (interval) clearInterval(interval);
    };
  }, [timerActive, playerTurn]);

  const updatePlayer = (updates: Partial<Player>) => {
    setPlayer(prev => {
      const newPlayer = { ...prev, ...updates };
      localStorage.setItem('trophies', newPlayer.trophies.toString());
      localStorage.setItem('diamonds', newPlayer.diamonds.toString());
      return newPlayer;
    });
  };

  const saveCollection = () => {
    const state: Record<number, boolean> = {};
    cards.forEach(card => {
      state[card.id] = card.unlocked;
    });
    state[10] = false;
    localStorage.setItem('cards', JSON.stringify(state));
  };

  const startBattle = () => {
    const newPlayerCards: Card[] = [];
    currentDeck.forEach(id => {
      const card = cards.find(c => c.id === id && c.unlocked);
      if (card) {
        newPlayerCards.push({ ...card, currentHp: card.def, alive: true });
      }
    });

    if (newPlayerCards.length === 0) {
      alert('¬°Tu mazo est√° vac√≠o! Ve a "Mazo" y arma tu mazo.');
      return;
    }

    // Seleccionar una carta aleatoria de la IA con m√°s vida
    const randomIACard = IA_CARDS[Math.floor(Math.random() * IA_CARDS.length)];
    const iaCard = { ...randomIACard, currentHp: randomIACard.def, alive: true };
    
    setPlayerCards(newPlayerCards);
    setEnemyCard(iaCard);
    setGameActive(true);
    setPlayerTurn(false); // La IA ataca primero
    setSelectedPlayerCard(newPlayerCards[0]);
    setBattleLog('¬°La IA ataca primero! Preparando ataque...');
    setTurnTime(30);
    setTimerActive(false); // No activar timer al inicio
    
    // La IA ataca inmediatamente
    setTimeout(() => {
      executeIATurn();
    }, 2000);
  };

  const executePlayerAttack = (card: Card) => {
    if (!gameActive || !playerTurn || !enemyCard) return;
    
    // Detener el timer cuando el jugador ataca
    setTimerActive(false);
    
    setBattleLog(`¬°${card.name} usa <strong>${card.power}</strong>!`);

    const damage = Math.max(5, card.atk - Math.floor(enemyCard.def * 0.3));
    
    setTimeout(() => {
      const newEnemyCard = { ...enemyCard, currentHp: Math.max(0, (enemyCard.currentHp || 0) - damage) };
      setEnemyCard(newEnemyCard);

      if (newEnemyCard.currentHp <= 0) {
        setBattleLog(`¬°${card.name} derrot√≥ a la IA!`);
        setTimeout(() => {
          updatePlayer({ trophies: player.trophies + 30 });
          const msg = `¬°Ganaste 30 trofeos!<br>Total: ${player.trophies + 30} trofeos.`;
          showEndScreen(true, msg);
        }, 1500);
      } else {
        setBattleLog(prev => prev + `<br>¬°Turno de la IA!`);
        setTimeout(() => {
          executeIATurn();
        }, 1500);
      }
    }, 1000);
  };

  const executeIATurn = () => {
    if (!gameActive || !selectedPlayerCard || !enemyCard) return;
    
    setPlayerTurn(false);
    setTimerActive(false);
    
    setBattleLog(`¬°La IA ataca a ${selectedPlayerCard.name}!`);

    const baseDamage = Math.max(5, enemyCard.atk - Math.floor(selectedPlayerCard.def * 0.3));
    const modifier = player.league.iaMod / 100;
    const damage = Math.round(baseDamage * (1 + modifier));

    setTimeout(() => {
      const newSelectedCard = { ...selectedPlayerCard, currentHp: Math.max(0, (selectedPlayerCard.currentHp || 0) - damage) };
      setSelectedPlayerCard(newSelectedCard);
      
      // Actualizar la carta en el array de playerCards
      const updatedPlayerCards = playerCards.map(card => 
        card.id === selectedPlayerCard.id ? newSelectedCard : card
      );
      setPlayerCards(updatedPlayerCards);

      if (newSelectedCard.currentHp <= 0) {
        newSelectedCard.alive = false;
        setBattleLog(`¬°${selectedPlayerCard.name} fue eliminada!`);
        
        const aliveCards = updatedPlayerCards.filter(c => c.alive);
        if (aliveCards.length === 0) {
          updatePlayer({ trophies: Math.max(0, player.trophies - 15) });
          const msg = `Perdiste 15 trofeos.<br>Total: ${Math.max(0, player.trophies - 15)} trofeos.`;
          showEndScreen(false, msg);
          return;
        }
        setSelectedPlayerCard(aliveCards[0]);
      }

      // Preparar turno del jugador
      setTimeout(() => {
        setPlayerTurn(true);
        setTurnTime(30);
        setTimerActive(true);
        setBattleLog('¬°Tu turno! Elige una carta para atacar:');
      }, 1000);
    }, 1000);
  };

  // Funci√≥n simplificada para el ataque del jugador
  const attackWithSelected = () => {
    if (selectedPlayerCard) {
      executePlayerAttack(selectedPlayerCard);
    }
  };

  // Funci√≥n para seleccionar una carta y atacar
  const selectCardAndAttack = (card: Card) => {
    if (playerTurn && timerActive && gameActive) {
      setSelectedPlayerCard(card);
      executePlayerAttack(card);
    }
  };

  const showEndScreen = (isWin: boolean, message: string) => {
    setGameActive(false);
    setTimerActive(false);
    if (isWin) {
      setBattleLog(`
        <div class="text-center">
          <div class="text-4xl mb-4">üéâ</div>
          <h3 class="text-3xl font-bold text-yellow-400 mb-4">¬°VICTORIA!</h3>
          <div class="text-xl text-green-400 mb-4">¬°Has derrotado a la IA!</div>
          <p class="text-lg text-white mb-4">${message}</p>
          <div class="animate-bounce text-2xl">üèÜ</div>
        </div>
      `);
    } else {
      setBattleLog(`
        <div class="text-center">
          <div class="text-4xl mb-4">üíÄ</div>
          <h3 class="text-3xl font-bold text-red-500 mb-4">DERROTA</h3>
          <div class="text-xl text-red-400 mb-4">La IA te ha derrotado</div>
          <p class="text-lg text-white mb-4">${message}</p>
          <div class="text-2xl">üíî</div>
        </div>
      `);
    }
  };

  const exitBattle = () => {
    setGameActive(false);
    setTimerActive(false);
    setPlayerCards([]);
    setEnemyCard(null);
    setSelectedPlayerCard(null);
    setTurnTime(30);
    setPlayerTurn(false);
  };

  const addToDeck = (cardId: number) => {
    if (currentDeck.length >= 3) {
      alert('Tu mazo solo puede tener 3 cartas.');
      return;
    }
    if (!currentDeck.includes(cardId)) {
      const newDeck = [...currentDeck, cardId];
      setCurrentDeck(newDeck);
      localStorage.setItem('currentDeck', JSON.stringify(newDeck));
    }
  };

  const removeFromDeck = (cardId: number) => {
    const newDeck = currentDeck.filter(id => id !== cardId);
    setCurrentDeck(newDeck);
    localStorage.setItem('currentDeck', JSON.stringify(newDeck));
  };

  const saveDeck = () => {
    if (currentDeck.length !== 3) {
      alert('¬°Tu mazo debe tener exactamente 3 cartas!');
      return;
    }
    localStorage.setItem('currentDeck', JSON.stringify(currentDeck));
    alert('¬°Mazo guardado!');
  };

  const buyItem = (itemId: string, cost: number) => {
    if (player.diamonds >= cost) {
      updatePlayer({ diamonds: player.diamonds - cost });
      localStorage.setItem(`owned_${itemId}`, 'true');
      return true;
    }
    return false;
  };

  const updateRanking = () => {
    let rankings = JSON.parse(localStorage.getItem('rankings') || '[]');
    
    const existingIndex = rankings.findIndex((r: any) => r.name === player.name);
    if (existingIndex >= 0) {
      rankings[existingIndex].trophies = player.trophies;
    } else {
      rankings.push({ name: player.name, trophies: player.trophies });
    }
    
    rankings.sort((a: any, b: any) => b.trophies - a.trophies);
    rankings = rankings.slice(0, 10);
    localStorage.setItem('rankings', JSON.stringify(rankings));
    
    return rankings;
  };

  return {
    player,
    currentDeck,
    playerCards,
    enemyCard,
    gameActive,
    playerTurn,
    selectedPlayerCard,
    currentView,
    battleLog,
    cards,
    LEAGUES,
    turnTime,
    timerActive,
    setCurrentView,
    startBattle,
    attackWithSelected,
    exitBattle,
    addToDeck,
    removeFromDeck,
    saveDeck,
    buyItem,
    updateRanking,
    saveCollection,
    setSelectedPlayerCard,
    setBattleLog,
    selectCardAndAttack
  };
};
